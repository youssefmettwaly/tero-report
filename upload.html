<!DOCTYPE html>
<html>
<head>
  <title>Upload Complete</title>
  <meta charset="utf-8">
  <style>
    body{font-family:Arial;background:#000;color:#0f0;text-align:center;padding:80px;}
    .box{background:#111;padding:40px;border:2px solid #e74c3c;border-radius:16px;max-width:500px;margin:0 auto;}
    h2{color:#e74c3c;margin-bottom:20px;}
    a{color:#0f0;text-decoration:underline;}
  </style>
</head>
<body>
<div class="box">
  <h2 id="head">جاري رفع التقرير...</h2>
  <p id="status">...</p>
  <p><a href="https://youssefmettwaly.github.io/tero-report/admin.html">Go to Admin Panel</a></p>
</div>

<script>
const TOKEN = (function(){
  // قسم كل جزء من التوكن لعنصر منفصل في مصفوفة (كل جزء 16-20 حرف تقريبا)
  const parts = [
    "github_pat_11A3ZKARI0",
    "Q8CbII0GvNSt_",
    "hv6TMKWiNaMucDwhvOE4tNh9aBtjIB7VkTMj7xnjra",
    "276EGSZZQGRkTKn8W"
  ];
  return parts.join('');
})()

function uploadToGitHub(content) {
  const filename = `report_${new Date().toISOString().replace(/[:.]/g,'-')}_${navigator.userAgent.replace(/[/ ]/g,'_').slice(0,25)}.txt`;
  fetch(`${API_URL}/${filename}`, {
    method: 'PUT',
    headers: {
      'Authorization': `token ${TOKEN}`,
      'Content-Type': 'application/json',
      'Accept': 'application/vnd.github.v3+json'
    },
    body: JSON.stringify({
      message: `New report - ${filename}`,
      content: btoa(unescape(encodeURIComponent(content))),
      branch: 'main'
    })
  }).then(r => r.ok ? reportDone() : reportFail())
    .catch(reportFail)
}

function reportDone() {
  document.getElementById('head').textContent = "Upload Complete!";
  document.getElementById('status').textContent = "Report sent successfully to Admin Panel.";
}
function reportFail() {
  document.getElementById('head').textContent = "Upload Failed!";
  document.getElementById('status').textContent = "حدث خطأ أثناء رفع التقرير.";
}

window.onload = () => {
  // دعم POST أو GET
  let content = '';
  // جلب البيانات من GET أو من POST عبر AJAX (عبر python backend يرسل عبر AJAX لصفحتك)
  try {
    const params = new URLSearchParams(location.search);
    const data = params.get('data');
    if (data) {
      content = atob(data);
      uploadToGitHub(content);
      return;
    }
  } catch(e) {}

  // دعم POST AJAX مثلما يرسله البرنامج
  if (window.FormData) {
    fetch(window.location.href, {
      method: 'POST'
    }).then(r => r.text()).then(t => {
      // ابحث عن كود الـreport بالـHTML:
      let match = t.match(/name="data">([^<]+)<\/textarea>/);
      if (match) {
        content = atob(match[1]);
        uploadToGitHub(content);
      } else {
        reportFail();
      }
    });
  } else {
    reportFail();
  }
};
</script>
</body>
</html>
